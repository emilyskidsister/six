.PHONY: clean all

all: ../src/corefont.rs

tmp/Bravura.json: Bravura.svg Makefile
	@mkdir -p tmp
	xq -a '{unitsPerEm: .svg.defs.font["font-face"]["@units-per-em"] | tonumber, glyphs: [.svg.defs.font.glyph[] | {key: .["@unicode"], value: {adv: (.["@horiz-adv-x"] // 0) | tonumber, d: .["@d"]}} | select((.key | type) == "string")] | from_entries}' ./Bravura.svg | sed -e 's/\\\u\([a-zA-Z0-9]*\)/U+\U\1/g' > tmp/Bravura.json

tmp/corefont.json: tmp/Bravura.json core.json glyphnames.json bravura_metadata.json Makefile
	@mkdir -p tmp
	jq -s '.[0] as $$font | .[1] as $$core | .[2] as $$glyphnames | .[3] as $$fontmeta | {unitsPerEm: $$font.unitsPerEm, engravingDefaults: $$fontmeta.engravingDefaults, glyphs: [$$core[] | [{name: .}, $$font.glyphs[$$glyphnames[.].codepoint], ($$fontmeta.glyphBBoxes[.] | [to_entries[] | {key: .key, value: [(.value[0] * $$font.unitsPerEm / 4 | round), (.value[1] * $$font.unitsPerEm / 4 | round)]}] | from_entries), ($$fontmeta.glyphsWithAnchors[.] // {} | [to_entries[] | {key: .key, value: [(.value[0] * $$font.unitsPerEm / 4 | round), (.value[1] * $$font.unitsPerEm / 4 | round)]} ] | from_entries )] | add]}' ./tmp/Bravura.json ./core.json ./glyphnames.json ./bravura_metadata.json > ./tmp/corefont.json

../src/corefont.rs: tmp/corefont.json Makefile
	echo "// Generated by gen_corefont/Makefile. Do not edit." > ../src/corefont.rs
	jq -r '.unitsPerEm as $$unitsPerEm | .engravingDefaults | to_entries[] | "pub(crate) static " + (.key | gsub("(?<a>[A-Z])"; "_" + .a) | ascii_upcase) + ": f64 = " + ((.value*$$unitsPerEm / 4.0)|tostring) + "_f64;"' ./tmp/corefont.json >> ../src/corefont.rs
	cat ./tmp/corefont.json | jq -r '"pub(crate) static UNITS_PER_EM: usize = " + (.unitsPerEm|tostring) + ";"' >> ../src/corefont.rs
	cat ./tmp/corefont.json | jq -r '.glyphs[] | "pub(crate) static " + (.name | gsub("(?<a>[A-Z])"; "_" + .a) | ascii_upcase) + ": (f64, [f64; 4], &str) = (" + (.adv|tostring) + "_f64, [" + (.bBoxSW[0]|tostring) + "_f64," + (.bBoxSW[1]|tostring) + "_f64," + (.bBoxNE[0]|tostring) + "_f64," + (.bBoxNE[1]|tostring) + "_f64], \"" + .d + "\");"' >> ../src/corefont.rs
	cat ./tmp/corefont.json | jq -r '.glyphs[] | select(.stemDownNW) | "pub(crate) static " + (.name | gsub("(?<a>[A-Z])"; "_" + .a) | ascii_upcase) + "_STEM_DOWN: [f64; 2] = [" + (.stemDownNW[0]|tostring) + "_f64," + (.stemDownNW[1]|tostring) + "_f64];"' >> ../src/corefont.rs
	cat ./tmp/corefont.json | jq -r '.glyphs[] | select(.stemUpSE) | "pub(crate) static " + (.name | gsub("(?<a>[A-Z])"; "_" + .a) | ascii_upcase) + "_STEM_UP: [f64; 2] = [" + (.stemUpSE[0]|tostring) + "_f64," + (.stemUpSE[1]|tostring) + "_f64];"' >> ../src/corefont.rs
	cat ./tmp/corefont.json | jq -r '.glyphs[] | select(.stemUpNW) | "pub(crate) static " + (.name | gsub("(?<a>[A-Z])"; "_" + .a) | ascii_upcase) + "_STEM_UP: [f64; 2] = [" + (.stemUpNW[0]|tostring) + "_f64," + (.stemUpNW[1]|tostring) + "_f64];"' >> ../src/corefont.rs

clean:
	rm -fr tmp
